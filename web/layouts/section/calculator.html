<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">
<head>
    {{ if hugo.IsProduction }}
      {{ partial "gtm-header.html" (dict "context" . "environment" "production") }}
    {{ else }}
      {{ partial "gtm-header.html" (dict "context" . "environment" "development") }}
    {{ end }}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{ .Title }}</title>
    {{ partial "site-style.html" . }}
    <!-- Calculator-specific styles processed by Hugo -->
    {{ with partialCached "func/style/GetCalculatorCSS" "calculator-css" }}
    <link rel="stylesheet" href="{{ .RelPermalink }}">
    {{ end }}
    <!-- Calculator styles include collapse, fixed-action-bar, forms, dialog, and password partials -->
    <!-- PasswordGate visibility rules are in _password.scss partial -->
</head>
<body class="calculator-page pw-buttons-hidden pw-content-hidden">
    {{ if hugo.IsProduction }}
      {{ partial "gtm-body.html" (dict "context" . "environment" "production") }}
    {{ else }}
      {{ partial "gtm-body.html" (dict "context" . "environment" "development") }}
    {{ end }}
  {{/* Emit only a hash of the password (not the plaintext) so the DOM doesn't expose it. */}}
  {{ $pw := .Params.password }}
  {{ if $pw }}
    {{- /* Use Hugo's sha256 template func if available. */ -}}
    {{- $hash := "" -}}
    {{- with (sha256 $pw) -}}
      {{- $hash = . -}}
    {{- end -}}
    {{- if $hash -}}
      <main class="calculator-page__content flex flex-column items-center justify-center min-vh-100" data-protect-password-hash="{{ $hash }}">
    {{- else -}}
      <main class="calculator-page__content flex flex-column items-center justify-center min-vh-100">
    {{- end -}}
  {{ else }}
    <main class="calculator-page__content flex flex-column items-center justify-center min-vh-100">
  {{ end }}
      {{ .Content }}
    </main>
      {{/* Load base form helpers */}}
      {{ with resources.Get "js/form__helpers.js" }}
        {{ $fh := . }}
        {{ if hugo.IsProduction }}
          {{ $fh = $fh | minify | fingerprint }}
        {{ end }}
          <script src="{{ $fh.RelPermalink }}"></script>
        {{ else }}
          <script src="/assets/js/form__helpers.js"></script>
        {{ end }}

        {{/* Load tracking module before other scripts that depend on it */}}
        {{ with resources.Get "js/tracking.js" }}
        {{ $t := . }}
        {{ if hugo.IsProduction }}
          {{ $t = $t | minify | fingerprint }}
        {{ end }}
          <script src="{{ $t.RelPermalink }}"></script>
        {{ else }}
          <script src="/assets/js/tracking.js"></script>
        {{ end }}

        {{/* Calculator-specific scripts */}}
        {{ if in .File.Path "calculator" }}
            {{/* Shared collapse helper used by calculator forms */}}
            {{ with resources.Get "js/collapse-sections.js" }}
            {{ $cs := . }}
            {{ if hugo.IsProduction }}
              {{ $cs = $cs | minify | fingerprint }}
            {{ end }}
              <script src="{{ $cs.RelPermalink }}"></script>
            {{ else }}
              <script src="/assets/js/collapse-sections.js"></script>
            {{ end }}
          {{/* Load password gate for any calculator page */}}
          {{ with resources.Get "js/password__hide-content.js" }}
          {{ $p := . }}
          {{ if hugo.IsProduction }}
            {{ $p = $p | minify | fingerprint }}
          {{ end }}
            <script src="{{ $p.RelPermalink }}"></script>
          {{ else }}
            <script src="/assets/js/password__hide-content.js"></script>
          {{ end }}

          {{/* DIME calculator specific script only for dime page */}}
          {{ if in .File.Path "calculator/dime" }}
            {{ with resources.Get "js/form__dime-calculator.js" }}
            {{ $d := . }}
            {{ if hugo.IsProduction }}
              {{ $d = $d | minify | fingerprint }}
            {{ end }}
              <script src="{{ $d.RelPermalink }}"></script>
            {{ else }}
              <script src="/assets/js/form__dime-calculator.js"></script>
            {{ end }}
          {{ end }}

          {{/* Cashflow calculator specific script only for cashflow page */}}
          {{ if in .File.Path "calculator/cashflow" }}
            {{ with resources.Get "js/form__cashflow-calculator.js" }}
            {{ $c := . }}
            {{ if hugo.IsProduction }}
              {{ $c = $c | minify | fingerprint }}
            {{ end }}
              <script src="{{ $c.RelPermalink }}"></script>
            {{ else }}
              <script src="/assets/js/form__cashflow-calculator.js"></script>
            {{ end }}
          {{ end }}
        {{ end }}

  {{/* Fixed action bar for calculator pages. Allow pages to set .form_id or override action_bar_buttons in front matter. */}}
  {{ $formID := .Params.form_id }}
  {{ $buttons := .Params.action_bar_buttons }}
  {{/* Only show action bar if page has a form_id (actual calculator pages, not the home page) */}}
  {{ if $formID }}
    {{ if $buttons }}
      {{ partial "fixed-action-bar.html" (dict "Buttons" $buttons "FormID" $formID "Page" .) }}
    {{ else }}
      {{ partial "fixed-action-bar.html" (dict "FormID" $formID "Page" .) }}
    {{ end }}
  {{ end }}

  {{/* Notes dialog partial - only included on calculator pages */}}
  {{ partial "notes-dialog.html" . }}

  {{/* Privacy banner for GDPR/cookie compliance */}}
  {{ partial "privacy-banner.html" . }}

</body>
</html>
