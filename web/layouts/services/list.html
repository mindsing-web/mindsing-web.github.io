{{ define "main" }}
  <article class="nested-copy-line-height nested-img {{ .Params.article_class }}">
    <div class="nested-copy-line-height lh-copy mw8 center {{ $.Param "article_class" | default "serif" }} f4 nested-links nested-img mid-gray">
      <section class="ph3 ph5-l pv3 pv4-l f4 tl lh-copy black">
        {{- .Content -}}
      </section>
    </div>

    {{/* Paginator / summaries (full-width below content on narrow screens) */}}
    <section class="w-100 ph3 ph5-l mt4 mw9 center">
      <div class="flex-ns flex-wrap justify-start">
        {{ range .Paginator.Pages }}
          <div class="relative w-100 w-50-l pr4-l mb4 bg-white">
            {{- partial "summary.html" . -}}
          </div>
        {{ end }}
      </div>
    </section>

    {{- template "_internal/pagination.html" . -}}
  </article>

  {{/* FAQ Section for Services Overview */}}
  {{ $faqData := site.Data.services_faq }}
  {{ if $faqData }}
  <section class="faq-section-wrapper pv5 ph3">
    <div class="mw8 center">
      <div class="flex justify-between items-center mb4">
        <h2 class="f2 fw6 dark-gray ma0">Frequently Asked Questions</h2>
        <button class="faq-toggle-all bn bg-white dark-gray ba b--moon-gray ph3 pv2 br2 pointer f6 fw6" data-target="services-faq">
          Expand All
        </button>
      </div>

      {{/* FAQ Schema */}}
      <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
          {{- range $index, $faq := $faqData.faqs -}}
          {{- if $index }},{{ end }}
          {
            "@type": "Question",
            "name": {{ $faq.question | jsonify }},
            "acceptedAnswer": {
              "@type": "Answer",
              "text": {{ $faq.answer | plainify | jsonify }}
            }
          }
          {{- end -}}
        ]
      }
      </script>

      <div class="faq-list" id="services-faq">
        {{ range $index, $faq := $faqData.faqs }}
        <div class="faq-item{{ if ne (add $index 1) (len $faqData.faqs) }} bb b--moon-gray{{ end }}">
          <button class="faq-question w-100 tl pa3 bn bg-transparent pointer flex justify-between items-center" aria-expanded="false">
            <span class="f4 fw6 dark-gray pr3">{{ $faq.question }}</span>
            <span class="faq-icon flex-shrink-0 f3 dark-gray">+</span>
          </button>
          <div class="faq-answer dn ph3 pb3">
            <div class="f5 lh-copy mid-gray nested-links pt2">
              {{ $faq.answer | markdownify }}
            </div>
          </div>
        </div>
        {{ end }}
      </div>
    </div>
  </section>
  {{ else }}
  <section class="pv5 ph3">
    <div class="mw8 center">
      <p class="red">FAQ data not found. Debugging: {{ printf "%#v" site.Data }}</p>
    </div>
  </section>
  {{ end }}

  <script>
  (function() {
    // Toggle individual FAQ items
    document.querySelectorAll('.faq-question').forEach(button => {
      button.addEventListener('click', function() {
        const answer = this.nextElementSibling;
        const icon = this.querySelector('.faq-icon');
        const isExpanded = this.getAttribute('aria-expanded') === 'true';

        this.setAttribute('aria-expanded', !isExpanded);
        answer.classList.toggle('dn');
        icon.textContent = isExpanded ? '+' : '−';
      });
    });

    // Toggle all FAQs
    document.querySelectorAll('.faq-toggle-all').forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const container = document.getElementById(targetId);
        const allExpanded = Array.from(container.querySelectorAll('.faq-question'))
          .every(btn => btn.getAttribute('aria-expanded') === 'true');

        container.querySelectorAll('.faq-question').forEach(btn => {
          const answer = btn.nextElementSibling;
          const icon = btn.querySelector('.faq-icon');

          btn.setAttribute('aria-expanded', !allExpanded);
          if (allExpanded) {
            answer.classList.add('dn');
            icon.textContent = '+';
          } else {
            answer.classList.remove('dn');
            icon.textContent = '−';
          }
        });

        this.textContent = allExpanded ? 'Expand All' : 'Collapse All';
      });
    });
  })();
  </script>
{{ end }}
