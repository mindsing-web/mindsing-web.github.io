{{ define "header" }}
  {{ partial "page-header.html" . }}
{{ end }}

{{ define "main" }}
  <div class="center ph3 ph5-l">
    {{/* Category Sub-Navigation */}}
    <nav class="category-nav mw9 center mt4 mb4 overflow-x-auto" aria-label="Blog Categories">
      <ul class="list flex flex-wrap justify-center ma0 pa0">
        <li class="ma2">
          <a href="/blog/" class="link dim ph3 pv2 ba b--moon-gray br2 dib bg-white dark-gray">
            All Posts
          </a>
        </li>
        {{ $currentPermalink := .RelPermalink }}
        {{/* Get categories from section pages (the _index.md files in each category folder) */}}
        {{ range where .Site.Pages "Section" "blog" }}
          {{ if and (eq .Kind "section") (ne .RelPermalink "/blog/") }}
            {{ $isActive := eq $currentPermalink .RelPermalink }}
            <li class="ma2">
              <a href="{{ .Permalink }}" class="link dim ph3 pv2 ba b--moon-gray br2 dib {{ if $isActive }}bg-dark-gray white{{ else }}bg-white dark-gray{{ end }}">
                {{ .Title }}
              </a>
            </li>
          {{ end }}
        {{ end }}
      </ul>
    </nav>

    {{/* Category Title */}}
    <div class="mw9 center mb4">
      <h1 class="f2 f1-l athelas">{{ .Title }}</h1>
    </div>

    {{/* Blog Posts Grid - Filter by category */}}
    {{ $currentPermalink := .RelPermalink }}
    {{ $filteredPages := slice }}
    {{ range where .Site.RegularPages "Section" "blog" }}
      {{ if and .Parent (eq .Parent.RelPermalink $currentPermalink) }}
        {{ $filteredPages = $filteredPages | append . }}
      {{ end }}
    {{ end }}

    <article class="nested-copy-line-height nested-img">
      <section class="w-100 mw9 center">
        {{ if gt (len $filteredPages) 0 }}
          <div class="flex-ns flex-wrap justify-start">
            {{ range $filteredPages }}
              <div class="relative w-100 w-50-l pr4-l mb4 bg-white">
                {{- partial "summary.html" . -}}
              </div>
            {{ end }}
          </div>
        {{ else }}
          <p class="f4 lh-copy mid-gray tc pa4">No posts found in this category.</p>
        {{ end }}
      </section>
    </article>
  </div>
{{ end }}
